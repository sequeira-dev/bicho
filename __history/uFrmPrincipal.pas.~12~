unit uFrmPrincipal;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.WinXPickers, Vcl.StdCtrls, System.JSON, FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf, Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, FireDAC.Stan.StorageJSON,
  Vcl.ComCtrls, Vcl.ExtCtrls, Vcl.Grids, Vcl.DBGrids;

type
  TfrmPrincipal = class(TForm)
    fdmPrincipalGrupo: TFDMemTable;
    FDStanStorageJSONLink1: TFDStanStorageJSONLink;
    Panel1: TPanel;
    PageControl1: TPageControl;
    Panel2: TPanel;
    TabSheet1: TTabSheet;
    dsPrincipalGrupo: TDataSource;
    DBGrid1: TDBGrid;
    DatePicker1: TDatePicker;
    fdmPrincipalGrupodata: TDateField;
    fdmPrincipalGrupoaposta: TStringField;
    fdmPrincipalGrupohorario: TTimeField;
    fdmPrincipalGrupopremio: TIntegerField;
    fdmPrincipalGrupodezena: TIntegerField;
    procedure FormCreate(Sender: TObject);
  private
    procedure AtualizarMemo;
    procedure CarregarMemTable;
//    procedure btnAtualizarClick(Sender: TObject);
//    procedure btnCriarClick(Sender: TObject);
//    procedure btnExcluirClick(Sender: TObject);
//    procedure btnLerClick(Sender: TObject);
    procedure CriarArquivoJSON;
    function LerJSON: TJSONArray;
    procedure SalvarJSON(JSONArr: TJSONArray);
    procedure Salvar;
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmPrincipal: TfrmPrincipal;

implementation

{$R *.dfm}

const
  JSON_FILE = 'dados.json'; // Nome do arquivo JSON

procedure TfrmPrincipal.CarregarMemTable;
begin
  var JSONStream: TFileStream;
  begin
    if not FileExists(JSON_FILE) then
    begin
      ShowMessage('Arquivo JSON não encontrado!');
      Exit;
    end;

    JSONStream := TFileStream.Create(JSON_FILE, fmOpenRead);
    try
      fdmPrincipalGrupo.LoadFromStream(JSONStream, sfJSON);
      fdmPrincipalGrupo.Open;
    finally
      JSONStream.Free;
    end;
  end;
end;

procedure TfrmPrincipal.CriarArquivoJSON;
var
  JSONDia, JSONHorario: TJSONObject;
  JSONPremio: TJSONArray;
  JSONStr: TStringList;
begin

  if not FileExists(JSON_FILE) then
  begin
    JSONDia := TJSONObject.Create;
    JSONStr := TStringList.Create;

    try
      JSONStr.Text := JSONDia.ToJSON;
      JSONStr.SaveToFile(JSON_FILE);
    finally
      JSONDia.Free;
      JSONStr.Free;
    end;
  end;

end;

procedure TfrmPrincipal.FormCreate(Sender: TObject);
begin
 // CriarArquivoJSON;
 // Salvar;
  CarregarMemTable;
end;

function TfrmPrincipal.LerJSON: TJSONArray;
var
  JSONStr: TStringList;
  JSONValue: TJSONValue;
begin
  Result := TJSONArray.Create;
  JSONStr := TStringList.Create;
  try
    if FileExists(JSON_FILE) then
    begin
      JSONStr.LoadFromFile(JSON_FILE);
      JSONValue := TJSONObject.ParseJSONValue(JSONStr.Text);
      if Assigned(JSONValue) and (JSONValue is TJSONArray) then
        Result := TJSONArray(JSONValue)
      else
        JSONValue.Free;
    end;
  finally
    JSONStr.Free;
  end;
end;

procedure TfrmPrincipal.SalvarJSON(JSONArr: TJSONArray);
var
  JSONStr: TStringList;
begin
  JSONStr := TStringList.Create;
  try
    JSONStr.Text := JSONArr.ToJSON;
    JSONStr.SaveToFile(JSON_FILE);
  finally
    JSONStr.Free;
  end;
end;

procedure TfrmPrincipal.AtualizarMemo;
var
  JSONArr: TJSONArray;
  JSONObj: TJSONObject;
  i: Integer;
begin
{  Memo1.Clear;
  JSONArr := LerJSON;
  try
    for i := 0 to JSONArr.Count - 1 do
    begin
      JSONObj := JSONArr.Items[i] as TJSONObject;
      Memo1.Lines.Add(Format('ID: %d | Nome: %s | Idade: %d',
        [JSONObj.GetValue<Integer>('id'),
         JSONObj.GetValue<string>('nome'),
         JSONObj.GetValue<Integer>('idade')]));
    end;
  finally
    JSONArr.Free;
  end;              }
end;

procedure TfrmPrincipal.Salvar;
var
  JSONArr: TJSONArray;
  JSONObj: TJSONObject;
begin
  JSONArr := LerJSON;
  try
    JSONObj := TJSONObject.Create;
    JSONObj.AddPair('Data', DateToStr(DatePicker1.Date));
    JSONObj.AddPair('Aposta', 'Grupo');
    JSONObj.AddPair('Horario', '14:00');
    JSONObj.AddPair('Premio', TJSONNumber.Create(0));
    JSONObj.AddPair('Dezena', TJSONNumber.Create(20));
    JSONArr.AddElement(JSONObj);
    SalvarJSON(JSONArr);
    ShowMessage('Registro salvo com sucesso!');
  finally
    JSONArr.Free;
  end;
end;

{
procedure TfrmPrincipal.btnLerClick(Sender: TObject);
begin
  AtualizarMemo;
end;

procedure TfrmPrincipal.btnAtualizarClick(Sender: TObject);
var
  JSONArr: TJSONArray;
  JSONObj: TJSONObject;
  i, ID: Integer;
begin
  if (edtID.Text = '') or (edtNome.Text = '') or (edtIdade.Text = '') then
  begin
    ShowMessage('Preencha todos os campos!');
    Exit;
  end;

  ID := StrToInt(edtID.Text);
  JSONArr := LerJSON;
  try
    for i := 0 to JSONArr.Count - 1 do
    begin
      JSONObj := JSONArr.Items[i] as TJSONObject;
      if JSONObj.GetValue<Integer>('id') = ID then
      begin
        JSONObj.AddPair('nome', edtNome.Text);
        JSONObj.AddPair('idade', TJSONNumber.Create(StrToInt(edtIdade.Text)));
        Break;
      end;
    end;
    SalvarJSON(JSONArr);
    ShowMessage('Registro atualizado com sucesso!');
  finally
    JSONArr.Free;
  end;
  AtualizarMemo;
end;

procedure TfrmPrincipal.btnExcluirClick(Sender: TObject);
var
  JSONArr: TJSONArray;
  i, ID: Integer;
begin
  if edtID.Text = '' then
  begin
    ShowMessage('Informe o ID para excluir!');
    Exit;
  end;

  ID := StrToInt(edtID.Text);
  JSONArr := LerJSON;
  try
    for i := JSONArr.Count - 1 downto 0 do
    begin
      if (JSONArr.Items[i] as TJSONObject).GetValue<Integer>('id') = ID then
      begin
        JSONArr.Remove(i);
        Break;
      end;
    end;
    SalvarJSON(JSONArr);
    ShowMessage('Registro excluído com sucesso!');
  finally
    JSONArr.Free;
  end;
  AtualizarMemo;
end;
}



end.
